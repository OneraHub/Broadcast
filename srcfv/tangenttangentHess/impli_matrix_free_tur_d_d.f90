! This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.16 (master) -  9 Oct 2020 17:47
!
!  Differentiation of impli_matrix_free_rans_2d_d in forward (tangent) mode (with options with!SliceDeadControl with!SliceDeadIns
!trs with!StaticTaping):
!   variations   of useful results: dwid dwi
!   with respect to varying inputs: sigmad dtcoefd csd cfl prandtld
!                murefd s_suthd dw w src_id muref sigma volfd nxd
!                nx ny trefd prandtl tref vol dtcoef vold volf
!                nyd s_suth rgazd gamd src_i cfld cs rgaz cv dwd
!                wd cvd gam
!   RW status of diff variables: sigmad:in dtcoefd:in csd:in cfl:in
!                dwid:out prandtld:in murefd:in s_suthd:in dw:in
!                w:in src_id:in muref:in sigma:in volfd:in nxd:in
!                nx:in ny:in trefd:in prandtl:in tref:in vol:in
!                dtcoef:in vold:in volf:in nyd:in s_suth:in rgazd:in
!                gamd:in src_i:in cfld:in cs:in rgaz:in cv:in dwd:in
!                wd:in dwi:out cvd:in gam:in
!        Generated by TAPENADE     (INRIA, Ecuador team)
!  Tapenade 3.16 (master) -  9 Oct 2020 17:47
!
!  Differentiation of impli_matrix_free_rans_2d in forward (tangent) mode (with options with!SliceDeadControl with!SliceDeadInstr
!s with!StaticTaping):
!   variations   of useful results: dwi
!   with respect to varying inputs: cfl dw w muref sigma nx ny
!                prandtl tref vol dtcoef volf s_suth src_i cs rgaz
!                cv gam
!   RW status of diff variables: cfl:in dw:in w:in muref:in sigma:in
!                nx:in ny:in prandtl:in tref:in vol:in dtcoef:in
!                volf:in s_suth:in src_i:in cs:in rgaz:in cv:in
!                dwi:out gam:in
! =============================================================================
! Implicit matrix free phase 2D RANS coupled
! =============================================================================
SUBROUTINE IMPLI_MATRIX_FREE_RANS_2D_D_D(dwi, dwid0, dwid, dwidd, nx, &
& nxd0, nxd, nxdd, ny, nyd0, nyd, nydd, src_i, src_id0, src_id, src_idd&
& , w, wd0, wd, wdd, mut, dw, dwd0, dwd, dwdd, vol, vold0, vold, voldd, &
& volf, volfd0, volfd, volfdd, dtcoef, dtcoefd0, dtcoefd, dtcoefdd, cfl&
& , cfld0, cfld, cfldd, sigma, sigmad0, sigmad, sigmadd, gam, gamd0, &
& gamd, gamdd, rgaz, rgazd0, rgazd, rgazdd, prandtl, prandtld0, prandtld&
& , prandtldd, prandtlturb, lmax, gh, cv, cvd0, cvd, cvdd, cs, csd0, csd&
& , csdd, muref, murefd0, murefd, murefdd, tref, trefd0, trefd, trefdd, &
& s_suth, s_suthd0, s_suthd, s_suthdd, im, jm, em)
  IMPLICIT NONE
!
!
! variables for dimension -----------------------------------------
  INTEGER, INTENT(IN) :: em, im, jm, lmax
  INTEGER, INTENT(IN) :: gh
! required arguments ----------------------------------------------
  REAL*8, INTENT(IN) :: dtcoef, gam, rgaz, prandtl, prandtlturb, sigma
  REAL*8, INTENT(IN) :: dtcoefd0, gamd0, rgazd0, prandtld0, sigmad0
  REAL*8, INTENT(IN) :: dtcoefd, gamd, rgazd, prandtld, sigmad
  REAL*8, INTENT(IN) :: dtcoefdd, gamdd, rgazdd, prandtldd, sigmadd
  REAL*8, INTENT(IN) :: cv, cfl, cs, muref, tref, s_suth
  REAL*8, INTENT(IN) :: cvd0, cfld0, csd0, murefd0, trefd0, s_suthd0
  REAL*8, INTENT(IN) :: cvd, cfld, csd, murefd, trefd, s_suthd
  REAL*8, INTENT(IN) :: cvdd, cfldd, csdd, murefdd, trefdd, s_suthdd
  REAL*8, DIMENSION(1-gh:im+1+gh, 1-gh:jm+1+gh, 2), INTENT(IN) :: nx, ny
  REAL*8, DIMENSION(1-gh:im+1+gh, 1-gh:jm+1+gh, 2), INTENT(IN) :: nxd0, &
& nyd0
  REAL*8, DIMENSION(1-gh:im+1+gh, 1-gh:jm+1+gh, 2), INTENT(IN) :: nxd, &
& nyd
  REAL*8, DIMENSION(1-gh:im+1+gh, 1-gh:jm+1+gh, 2), INTENT(IN) :: nxdd, &
& nydd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2), INTENT(IN) :: volf
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2), INTENT(IN) :: volfd0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2), INTENT(IN) :: volfd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2), INTENT(IN) :: volfdd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: vol
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: vold0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: vold
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: voldd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: w
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: wd0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: wd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: wdd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: dw
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: dwd0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: dwd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(IN) :: dwdd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: mut
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: src_i
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: src_id0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: src_id
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh), INTENT(IN) :: src_idd
! Returned objects ------------------------------------------------
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(INOUT) :: dwi
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(INOUT) :: dwid0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(INOUT) :: dwid
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, em), INTENT(INOUT) :: dwidd
! Local variables -------------------------------------------------
  INTEGER :: i, j, l, equa, kdir, i0, j0, ipt, le, eq2
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh) :: mu, tloc
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh) :: mud0, tlocd0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh) :: mud, tlocd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh) :: mudd, tlocdd
  REAL*8, DIMENSION(0:im+1, 0:jm+1, em) :: d2w, dfi, dgi, hn, f, g
  REAL*8, DIMENSION(0:im+1, 0:jm+1, em) :: d2wd0, dfid0, dgid0, hnd0, &
& fd0, gd0
  REAL*8, DIMENSION(0:im+1, 0:jm+1, em) :: d2wd, dfid, dgid, hnd, fd, gd
  REAL*8, DIMENSION(0:im+1, 0:jm+1, em) :: d2wdd, dfidd, dgidd, hndd, &
& fdd, gdd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2) :: coefdiag
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2) :: coefdiagd0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2) :: coefdiagd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2) :: coefdiagdd
!specrad
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2, 2) :: coef
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2, 2) :: coefd0
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2, 2) :: coefd
  REAL*8, DIMENSION(1-gh:im+gh, 1-gh:jm+gh, 2, 2) :: coefdd
  REAL*8, DIMENSION(em) :: wi, fi, gi
  REAL*8, DIMENSION(em) :: wid0, fid0, gid0
  REAL*8, DIMENSION(em) :: wid, fid, gid
  REAL*8, DIMENSION(em) :: widd, fidd, gidd
  REAL*8 :: velxi, velyi, velzi, pint, tint, htot
  REAL*8 :: velxid0, velyid0, velzid0, pintd0, htotd0
  REAL*8 :: velxid, velyid, velzid, pintd, htotd
  REAL*8 :: velxidd, velyidd, velzidd, pintdd, htotdd
  REAL*8 :: rhom1, roki, norm, specdiff, iro, rol, ror, sigmainv
  REAL*8 :: rhom1d0, normd0, specdiffd0, irod0, rold0, rord0, sigmainvd0
  REAL*8 :: rhom1d, normd, specdiffd, irod, rold, rord, sigmainvd
  REAL*8 :: rhom1dd, normdd, specdiffdd, irodd, roldd, rordd, sigmainvdd
  REAL*8 :: one, half, zero, two, rom1l, rom1r, gampr, gamprt, mutot, &
& difftur
  REAL*8 :: rom1ld0, rom1rd0, gamprd0, mutotd0, diffturd0
  REAL*8 :: rom1ld, rom1rd, gamprd, mutotd, diffturd
  REAL*8 :: rom1ldd, rom1rdd, gamprdd, mutotdd, diffturdd
  REAL*8 :: uu, vv, cc, gam1, itur
  REAL*8 :: uud0, vvd0, ccd0, gam1d0
  REAL*8 :: uud, vvd, ccd, gam1d
  REAL*8 :: uudd, vvdd, ccdd, gam1dd
  REAL*8 :: dist, vitc, dt_euler, dt_ns, cflm1, distm1, cvm1
  REAL*8 :: distd0, vitcd0, dt_eulerd0, dt_nsd0, cflm1d0, cvm1d0
  REAL*8 :: distd, vitcd, dt_eulerd, dt_nsd, cflm1d, cvm1d
  REAL*8 :: distdd, vitcdd, dt_eulerdd, dt_nsdd, cflm1dd, cvm1dd
  REAL*8 :: ec, eloc, betas, rom1, dtm1, dt
  REAL*8 :: ecd0, elocd0, betasd0, rom1d0, dtm1d0
  REAL*8 :: ecd, elocd, betasd, rom1d, dtm1d
  REAL*8 :: ecdd, elocdd, betasdd, rom1dd, dtm1dd
  INTRINSIC SQRT
  INTRINSIC MIN
  INTRINSIC MAX
  INTRINSIC ABS
  REAL*8 :: x1
  REAL*8 :: x1d0
  REAL*8 :: x1d
  REAL*8 :: x1dd
  REAL*8 :: x2
  REAL*8 :: x2d0
  REAL*8 :: x2d
  REAL*8 :: x2dd
  REAL*8 :: x3
  REAL*8 :: x3d0
  REAL*8 :: x3d
  REAL*8 :: x3dd
  REAL*8 :: max1
  REAL*8 :: max1d0
  REAL*8 :: max1d
  REAL*8 :: max1dd
  REAL*8 :: abs0
  REAL*8 :: abs0d0
  REAL*8 :: abs0d
  REAL*8 :: abs0dd
  REAL*8 :: abs1
  REAL*8 :: abs1d0
  REAL*8 :: abs1d
  REAL*8 :: abs1dd
  REAL*8 :: result1
  REAL*8 :: result1d0
  REAL*8 :: result1d
  REAL*8 :: result1dd
  REAL*8 :: arg1
  REAL*8 :: arg1d0
  REAL*8 :: arg1d
  REAL*8 :: arg1dd
  REAL*8 :: arg2
  REAL*8 :: arg2d0
  REAL*8 :: arg2d
  REAL*8 :: arg2dd
  REAL*8 :: result2
  REAL*8 :: result2d0
  REAL*8 :: result2d
  REAL*8 :: result2dd
  REAL*8 :: temp
  REAL*8 :: tempd
  REAL*8 :: temp0
  REAL*8 :: temp0d
  REAL*8, DIMENSION(em) :: temp1
  REAL*8, DIMENSION(em) :: temp1d
  REAL*8, DIMENSION(em) :: temp2
  REAL*8, DIMENSION(em) :: temp2d
  REAL*8 :: temp3
  REAL*8 :: temp3d
  REAL*8, DIMENSION(im, jm) :: temp4
  REAL*8, DIMENSION(im, jm) :: temp4d
  REAL*8 :: temp5
  REAL*8 :: temp6
  REAL*8 :: temp7
  REAL*8, DIMENSION(em) :: temp8
  REAL*8, DIMENSION(em) :: temp9
  REAL*8, DIMENSION(im, jm) :: temp10
! -----------------------------------------------------------------
  half = 0.5d0
  zero = 0.d0
  two = 2.d0
  one = 1.d0
!
  dwi = zero
  dfi = zero
  dgi = zero
!
  temp5 = gam*prandtld/prandtl
  temp6 = (gamd-temp5)/prandtl
  gamprdd = 2.d0*(gamdd-(prandtld*gamd0+gam*prandtldd-temp5*prandtld0)/&
&   prandtl-temp6*prandtld0)/prandtl
  gamprd = 2.d0*temp6
  gamprd0 = 2.d0*(gamd0-gam*prandtld0/prandtl)/prandtl
  gampr = 2.d0*gam/prandtl
  gam1dd = gamdd
  gam1d = gamd
  gam1d0 = gamd0
  gam1 = gam - one
!
  temp6 = cfld/(cfl*cfl)
  cflm1dd = -(one*(cfldd-temp6*2*cfl*cfld0)/cfl**2)
  cflm1d = -(one*temp6)
  cflm1d0 = -(one*cfld0/cfl**2)
  cflm1 = one/cfl
  temp6 = cvd/(cv*cv)
  cvm1dd = -(one*(cvdd-temp6*2*cv*cvd0)/cv**2)
  cvm1d = -(one*temp6)
  cvm1d0 = -(one*cvd0/cv**2)
  cvm1 = one/cv
  temp6 = SQRT(tref)
  IF (tref .EQ. 0.0) THEN
    tempd = 0.0_8
  ELSE
    tempd = trefd0/(2.0*temp6)
  END IF
  temp = temp6
  IF (tref .EQ. 0.0) THEN
    result1d = 0.0_8
    result1dd = 0.0_8
  ELSE
    temp6 = trefd/(2.0*temp)
    result1dd = (trefdd-temp6*2.0*tempd)/(2.0*temp)
    result1d = temp6
  END IF
  result1d0 = tempd
  result1 = temp
  temp6 = muref*(tref+cs)/(result1*tref)
  tempd = ((tref+cs)*murefd0+muref*(trefd0+csd0)-temp6*(tref*result1d0+&
&   result1*trefd0))/(result1*tref)
  temp = temp6
  temp6 = tref*result1d + result1*trefd
  temp5 = ((tref+cs)*murefd+muref*(trefd+csd)-temp*temp6)/(result1*tref)
  betasdd = (murefd*(trefd0+csd0)+(tref+cs)*murefdd+(trefd+csd)*murefd0+&
&   muref*(trefdd+csdd)-temp6*tempd-temp*(result1d*trefd0+tref*result1dd&
&   +trefd*result1d0+result1*trefdd)-temp5*(tref*result1d0+result1*&
&   trefd0))/(result1*tref)
  betasd = temp5
  betasd0 = tempd
  betas = temp
  temp6 = sigmad/(sigma*sigma)
  sigmainvdd = -(one*(sigmadd-temp6*2*sigma*sigmad0)/sigma**2)
  sigmainvd = -(one*temp6)
  sigmainvd0 = -(one*sigmad0/sigma**2)
  sigmainv = one/sigma
  fd = 0.0_8
  gd = 0.0_8
  coefdiagd = 0.0_8
  tlocd = 0.0_8
  mud = 0.0_8
  fd0 = 0.0_8
  gd0 = 0.0_8
  tlocdd = 0.0_8
  coefdiagd0 = 0.0_8
  fdd = 0.0_8
  mudd = 0.0_8
  tlocd0 = 0.0_8
  gdd = 0.0_8
  coefdiagdd = 0.0_8
  mud0 = 0.0_8
  DO j=1-gh,jm+gh
    DO i=1-gh,im+gh
      rordd = wdd(i, j, 1)
      rord = wd(i, j, 1)
      rord0 = wd0(i, j, 1)
      ror = w(i, j, 1)
      temp6 = rord/(ror*ror)
      rom1dd = -(one*(rordd-temp6*2*ror*rord0)/ror**2)
      rom1d = -(one*temp6)
      rom1d0 = -(one*rord0/ror**2)
      rom1 = one/ror
      velxidd = wd(i, j, 2)*rom1d0 + rom1*wdd(i, j, 2) + rom1d*wd0(i, j&
&       , 2) + w(i, j, 2)*rom1dd
      velxid = rom1*wd(i, j, 2) + w(i, j, 2)*rom1d
      velxid0 = rom1*wd0(i, j, 2) + w(i, j, 2)*rom1d0
      velxi = w(i, j, 2)*rom1
      velyidd = wd(i, j, 3)*rom1d0 + rom1*wdd(i, j, 3) + rom1d*wd0(i, j&
&       , 3) + w(i, j, 3)*rom1dd
      velyid = rom1*wd(i, j, 3) + w(i, j, 3)*rom1d
      velyid0 = rom1*wd0(i, j, 3) + w(i, j, 3)*rom1d0
      velyi = w(i, j, 3)*rom1
      velzidd = wd(i, j, 4)*rom1d0 + rom1*wdd(i, j, 4) + rom1d*wd0(i, j&
&       , 4) + w(i, j, 4)*rom1dd
      velzid = rom1*wd(i, j, 4) + w(i, j, 4)*rom1d
      velzid0 = rom1*wd0(i, j, 4) + w(i, j, 4)*rom1d0
      velzi = w(i, j, 4)*rom1
!
      ecdd = half*(velxid*2*velxid0+2*velxi*velxidd+velyid*2*velyid0+2*&
&       velyi*velyidd+velzid*2*velzid0+2*velzi*velzidd)
      ecd = half*(2*velxi*velxid+2*velyi*velyid+2*velzi*velzid)
      ecd0 = half*(2*velxi*velxid0+2*velyi*velyid0+2*velzi*velzid0)
      ec = half*(velxi*velxi+velyi*velyi+velzi*velzi)
!
      tempd = wd0(i, j, 5) - ror*ecd0 - ec*rord0
      temp = w(i, j, 5) - ec*ror
      temp6 = wd(i, j, 5) - ror*ecd - ec*rord
      elocdd = temp6*rom1d0 + rom1*(wdd(i, j, 5)-ecd*rord0-ror*ecdd-rord&
&       *ecd0-ec*rordd) + rom1d*tempd + temp*rom1dd
      elocd = rom1*temp6 + temp*rom1d
      elocd0 = rom1*tempd + temp*rom1d0
      eloc = temp*rom1
!
      tlocdd(i, j) = elocd*cvm1d0 + cvm1*elocdd + cvm1d*elocd0 + eloc*&
&       cvm1dd
      tlocd(i, j) = cvm1*elocd + eloc*cvm1d
      tlocd0(i, j) = cvm1*elocd0 + eloc*cvm1d0
      tloc(i, j) = eloc*cvm1
!
      temp6 = rgaz*rord + ror*rgazd
      pintdd = temp6*tlocd0(i, j) + tloc(i, j)*(rord*rgazd0+rgaz*rordd+&
&       rgazd*rord0+ror*rgazdd) + tlocd(i, j)*(rgaz*rord0+ror*rgazd0) + &
&       ror*rgaz*tlocdd(i, j)
      pintd = tloc(i, j)*temp6 + ror*rgaz*tlocd(i, j)
      pintd0 = tloc(i, j)*(rgaz*rord0+ror*rgazd0) + ror*rgaz*tlocd0(i, j&
&       )
      pint = ror*rgaz*tloc(i, j)
      htotdd = (wd(i, j, 5)+pintd)*rom1d0 + rom1*(wdd(i, j, 5)+pintdd) +&
&       rom1d*(wd0(i, j, 5)+pintd0) + (w(i, j, 5)+pint)*rom1dd
      htotd = rom1*(wd(i, j, 5)+pintd) + (w(i, j, 5)+pint)*rom1d
      htotd0 = rom1*(wd0(i, j, 5)+pintd0) + (w(i, j, 5)+pint)*rom1d0
      htot = (w(i, j, 5)+pint)*rom1
      fdd(i, j, 1) = wdd(i, j, 2)
      fd(i, j, 1) = wd(i, j, 2)
      fd0(i, j, 1) = wd0(i, j, 2)
      f(i, j, 1) = w(i, j, 2)
      fdd(i, j, 2) = wd(i, j, 2)*velxid0 + velxi*wdd(i, j, 2) + velxid*&
&       wd0(i, j, 2) + w(i, j, 2)*velxidd + pintdd
      fd(i, j, 2) = velxi*wd(i, j, 2) + w(i, j, 2)*velxid + pintd
      fd0(i, j, 2) = velxi*wd0(i, j, 2) + w(i, j, 2)*velxid0 + pintd0
      f(i, j, 2) = w(i, j, 2)*velxi + pint
      fdd(i, j, 3) = wd(i, j, 2)*velyid0 + velyi*wdd(i, j, 2) + velyid*&
&       wd0(i, j, 2) + w(i, j, 2)*velyidd
      fd(i, j, 3) = velyi*wd(i, j, 2) + w(i, j, 2)*velyid
      fd0(i, j, 3) = velyi*wd0(i, j, 2) + w(i, j, 2)*velyid0
      f(i, j, 3) = w(i, j, 2)*velyi
      fdd(i, j, 4) = wd(i, j, 2)*velzid0 + velzi*wdd(i, j, 2) + velzid*&
&       wd0(i, j, 2) + w(i, j, 2)*velzidd
      fd(i, j, 4) = velzi*wd(i, j, 2) + w(i, j, 2)*velzid
      fd0(i, j, 4) = velzi*wd0(i, j, 2) + w(i, j, 2)*velzid0
      f(i, j, 4) = w(i, j, 2)*velzi
      fdd(i, j, 5) = wd(i, j, 2)*htotd0 + htot*wdd(i, j, 2) + htotd*wd0(&
&       i, j, 2) + w(i, j, 2)*htotdd
      fd(i, j, 5) = htot*wd(i, j, 2) + w(i, j, 2)*htotd
      fd0(i, j, 5) = htot*wd0(i, j, 2) + w(i, j, 2)*htotd0
      f(i, j, 5) = w(i, j, 2)*htot
      gdd(i, j, 1) = wdd(i, j, 3)
      gd(i, j, 1) = wd(i, j, 3)
      gd0(i, j, 1) = wd0(i, j, 3)
      g(i, j, 1) = w(i, j, 3)
      gdd(i, j, 2) = wd(i, j, 3)*velxid0 + velxi*wdd(i, j, 3) + velxid*&
&       wd0(i, j, 3) + w(i, j, 3)*velxidd
      gd(i, j, 2) = velxi*wd(i, j, 3) + w(i, j, 3)*velxid
      gd0(i, j, 2) = velxi*wd0(i, j, 3) + w(i, j, 3)*velxid0
      g(i, j, 2) = w(i, j, 3)*velxi
      gdd(i, j, 3) = wd(i, j, 3)*velyid0 + velyi*wdd(i, j, 3) + velyid*&
&       wd0(i, j, 3) + w(i, j, 3)*velyidd + pintdd
      gd(i, j, 3) = velyi*wd(i, j, 3) + w(i, j, 3)*velyid + pintd
      gd0(i, j, 3) = velyi*wd0(i, j, 3) + w(i, j, 3)*velyid0 + pintd0
      g(i, j, 3) = w(i, j, 3)*velyi + pint
      gdd(i, j, 4) = wd(i, j, 3)*velzid0 + velzi*wdd(i, j, 3) + velzid*&
&       wd0(i, j, 3) + w(i, j, 3)*velzidd
      gd(i, j, 4) = velzi*wd(i, j, 3) + w(i, j, 3)*velzid
      gd0(i, j, 4) = velzi*wd0(i, j, 3) + w(i, j, 3)*velzid0
      g(i, j, 4) = w(i, j, 3)*velzi
      gdd(i, j, 5) = wd(i, j, 3)*htotd0 + htot*wdd(i, j, 3) + htotd*wd0(&
&       i, j, 3) + w(i, j, 3)*htotdd
      gd(i, j, 5) = htot*wd(i, j, 3) + w(i, j, 3)*htotd
      gd0(i, j, 5) = htot*wd0(i, j, 3) + w(i, j, 3)*htotd0
      g(i, j, 5) = w(i, j, 3)*htot
!h(i,j,1) = w(i,j,4)
!h(i,j,2) = w(i,j,4) * velx(i,j)
!h(i,j,3) = w(i,j,4) * vely(i,j)
!h(i,j,4) = w(i,j,4) * velz(i,j) + pint
!h(i,j,5) = w(i,j,4) * htot
      temp6 = SQRT(tloc(i, j))
      IF (tloc(i, j) .EQ. 0.0) THEN
        tempd = 0.0_8
      ELSE
        tempd = tlocd0(i, j)/(2.0*temp6)
      END IF
      temp = temp6
      IF (tloc(i, j) .EQ. 0.0) THEN
        result1d = 0.0_8
        result1dd = 0.0_8
      ELSE
        temp6 = tlocd(i, j)/(2.0*temp)
        result1dd = (tlocdd(i, j)-temp6*2.0*tempd)/(2.0*temp)
        result1d = temp6
      END IF
      result1d0 = tempd
      result1 = temp
      temp6 = betas*result1*tloc(i, j)/(tloc(i, j)+s_suth)
      tempd = (tloc(i, j)*(result1*betasd0+betas*result1d0)+betas*&
&       result1*tlocd0(i, j)-temp6*(tlocd0(i, j)+s_suthd0))/(tloc(i, j)+&
&       s_suth)
      temp = temp6
      temp6 = result1*betasd + betas*result1d
      temp5 = (tloc(i, j)*temp6+betas*result1*tlocd(i, j)-temp*(tlocd(i&
&       , j)+s_suthd))/(tloc(i, j)+s_suth)
      mudd(i, j) = (temp6*tlocd0(i, j)+tloc(i, j)*(betasd*result1d0+&
&       result1*betasdd+result1d*betasd0+betas*result1dd)+tlocd(i, j)*(&
&       result1*betasd0+betas*result1d0)+betas*result1*tlocdd(i, j)-(&
&       tlocd(i, j)+s_suthd)*tempd-temp*(tlocdd(i, j)+s_suthdd)-temp5*(&
&       tlocd0(i, j)+s_suthd0))/(tloc(i, j)+s_suth)
      mud(i, j) = temp5
      mud0(i, j) = tempd
      mu(i, j) = temp
      DO itur=6,em
        tempd = rom1*wd0(i, j, 2) + w(i, j, 2)*rom1d0
        temp = w(i, j, 2)*rom1
        temp6 = rom1*wd(i, j, 2) + w(i, j, 2)*rom1d
        fdd(i, j, itur) = temp6*wd0(i, j, itur) + w(i, j, itur)*(wd(i, j&
&         , 2)*rom1d0+rom1*wdd(i, j, 2)+rom1d*wd0(i, j, 2)+w(i, j, 2)*&
&         rom1dd) + wd(i, j, itur)*tempd + temp*wdd(i, j, itur)
        fd(i, j, itur) = w(i, j, itur)*temp6 + temp*wd(i, j, itur)
        fd0(i, j, itur) = w(i, j, itur)*tempd + temp*wd0(i, j, itur)
        f(i, j, itur) = temp*w(i, j, itur)
        tempd = rom1*wd0(i, j, 3) + w(i, j, 3)*rom1d0
        temp = w(i, j, 3)*rom1
        temp6 = rom1*wd(i, j, 3) + w(i, j, 3)*rom1d
        gdd(i, j, itur) = temp6*wd0(i, j, itur) + w(i, j, itur)*(wd(i, j&
&         , 3)*rom1d0+rom1*wdd(i, j, 3)+rom1d*wd0(i, j, 3)+w(i, j, 3)*&
&         rom1dd) + wd(i, j, itur)*tempd + temp*wdd(i, j, itur)
        gd(i, j, itur) = w(i, j, itur)*temp6 + temp*wd(i, j, itur)
        gd0(i, j, itur) = w(i, j, itur)*tempd + temp*wd0(i, j, itur)
        g(i, j, itur) = temp*w(i, j, itur)
      END DO
      temp6 = 2*nx(i, j, 1)
      temp5 = 2*ny(i, j, 1)
      arg1dd = nxd(i, j, 1)*2*nxd0(i, j, 1) + temp6*nxdd(i, j, 1) + nyd(&
&       i, j, 1)*2*nyd0(i, j, 1) + temp5*nydd(i, j, 1)
      arg1d = temp6*nxd(i, j, 1) + temp5*nyd(i, j, 1)
      arg1d0 = 2*nx(i, j, 1)*nxd0(i, j, 1) + 2*ny(i, j, 1)*nyd0(i, j, 1)
      arg1 = nx(i, j, 1)*nx(i, j, 1) + ny(i, j, 1)*ny(i, j, 1)
      temp6 = SQRT(arg1)
      IF (arg1 .EQ. 0.0) THEN
        tempd = 0.0_8
      ELSE
        tempd = arg1d0/(2.0*temp6)
      END IF
      temp = temp6
      IF (arg1 .EQ. 0.0) THEN
        result1d = 0.0_8
        result1dd = 0.0_8
      ELSE
        temp6 = arg1d/(2.0*temp)
        result1dd = (arg1dd-temp6*2.0*tempd)/(2.0*temp)
        result1d = temp6
      END IF
      result1d0 = tempd
      result1 = temp
      temp6 = 2*nx(i, j, 2)
      temp5 = 2*ny(i, j, 2)
      arg2dd = nxd(i, j, 2)*2*nxd0(i, j, 2) + temp6*nxdd(i, j, 2) + nyd(&
&       i, j, 2)*2*nyd0(i, j, 2) + temp5*nydd(i, j, 2)
      arg2d = temp6*nxd(i, j, 2) + temp5*nyd(i, j, 2)
      arg2d0 = 2*nx(i, j, 2)*nxd0(i, j, 2) + 2*ny(i, j, 2)*nyd0(i, j, 2)
      arg2 = nx(i, j, 2)*nx(i, j, 2) + ny(i, j, 2)*ny(i, j, 2)
      temp6 = SQRT(arg2)
      IF (arg2 .EQ. 0.0) THEN
        tempd = 0.0_8
      ELSE
        tempd = arg2d0/(2.0*temp6)
      END IF
      temp = temp6
      IF (arg2 .EQ. 0.0) THEN
        result2d = 0.0_8
        result2dd = 0.0_8
      ELSE
        temp6 = arg2d/(2.0*temp)
        result2dd = (arg2dd-temp6*2.0*tempd)/(2.0*temp)
        result2d = temp6
      END IF
      result2d0 = tempd
      result2 = temp
      temp6 = vol(i, j)/(result1+result2)
      tempd = (vold0(i, j)-temp6*(result1d0+result2d0))/(result1+result2&
&       )
      temp = temp6
      temp6 = (vold(i, j)-temp*(result1d+result2d))/(result1+result2)
      distdd = (voldd(i, j)-(result1d+result2d)*tempd-temp*(result1dd+&
&       result2dd)-temp6*(result1d0+result2d0))/(result1+result2)
      distd = temp6
      distd0 = tempd
      dist = temp
      temp6 = pint*gamd + gam*pintd
      arg1dd = temp6*rom1d0 + rom1*(gamd*pintd0+pint*gamdd+pintd*gamd0+&
&       gam*pintdd) + rom1d*(pint*gamd0+gam*pintd0) + gam*pint*rom1dd
      arg1d = rom1*temp6 + gam*pint*rom1d
      arg1d0 = rom1*(pint*gamd0+gam*pintd0) + gam*pint*rom1d0
      arg1 = gam*pint*rom1
      temp6 = SQRT(arg1)
      IF (arg1 .EQ. 0.0) THEN
        tempd = 0.0_8
      ELSE
        tempd = arg1d0/(2.0*temp6)
      END IF
      temp = temp6
      IF (arg1 .EQ. 0.0) THEN
        ccd = 0.0_8
        ccdd = 0.0_8
      ELSE
        temp6 = arg1d/(2.0*temp)
        ccdd = (arg1dd-temp6*2.0*tempd)/(2.0*temp)
        ccd = temp6
      END IF
      ccd0 = tempd
      cc = temp
      arg1dd = velxid*2*velxid0 + 2*velxi*velxidd + velyid*2*velyid0 + 2&
&       *velyi*velyidd
      arg1d = 2*velxi*velxid + 2*velyi*velyid
      arg1d0 = 2*velxi*velxid0 + 2*velyi*velyid0
      arg1 = velxi*velxi + velyi*velyi
      temp6 = SQRT(arg1)
      IF (arg1 .EQ. 0.0) THEN
        tempd = 0.0_8
      ELSE
        tempd = arg1d0/(2.0*temp6)
      END IF
      temp = temp6
      IF (arg1 .EQ. 0.0) THEN
        result1d = 0.0_8
        result1dd = 0.0_8
      ELSE
        temp6 = arg1d/(2.0*temp)
        result1dd = (arg1dd-temp6*2.0*tempd)/(2.0*temp)
        result1d = temp6
      END IF
      result1d0 = tempd
      result1 = temp
      vitcdd = result1dd + ccdd
      vitcd = result1d + ccd
      vitcd0 = result1d0 + ccd0
      vitc = result1 + cc
      temp6 = dist*vitcd/vitc
      temp5 = (distd-temp6)/vitc
      dt_eulerdd = (distdd-(vitcd*distd0+dist*vitcdd-temp6*vitcd0)/vitc-&
&       temp5*vitcd0)/vitc
      dt_eulerd = temp5
      dt_eulerd0 = (distd0-dist*vitcd0/vitc)/vitc
      dt_euler = dist/vitc
      tempd = mu(i, j)*gamprd0 + gampr*mud0(i, j)
      temp = gampr*mu(i, j)
      temp6 = ror/temp
      temp0d = temp6*2*dist*distd0 + dist**2*(rord0-temp6*tempd)/temp
      temp0 = dist*dist*temp6
      temp6 = 2*ror*dist
      temp5 = mu(i, j)*gamprd + gampr*mud(i, j)
      temp7 = (temp6*distd+dist*dist*rord-temp0*temp5)/temp
      dt_nsdd = half*(distd*(dist*2*rord0+2*ror*distd0)+temp6*distdd+&
&       rord*2*dist*distd0+dist**2*rordd-temp5*temp0d-temp0*(gamprd*mud0&
&       (i, j)+mu(i, j)*gamprdd+mud(i, j)*gamprd0+gampr*mudd(i, j))-&
&       temp7*tempd)/temp
      dt_nsd = half*temp7
      dt_nsd0 = half*temp0d
      dt_ns = half*temp0
      IF (dt_euler .GT. dt_ns) THEN
        x1dd = dt_nsdd
        x1d = dt_nsd
        x1d0 = dt_nsd0
        x1 = dt_ns
      ELSE
        x1dd = dt_eulerdd
        x1d = dt_eulerd
        x1d0 = dt_eulerd0
        x1 = dt_euler
      END IF
      IF (x1 .LT. 1.d-15) THEN
        max1 = 1.d-15
        max1d = 0.0_8
        max1d0 = 0.0_8
        max1dd = 0.0_8
      ELSE
        max1dd = x1dd
        max1d = x1d
        max1d0 = x1d0
        max1 = x1
      END IF
! 1/dt
      temp7 = cflm1*max1d/max1
      temp6 = (cflm1d-temp7)/max1
      dtm1dd = (cflm1dd-(max1d*cflm1d0+cflm1*max1dd-temp7*max1d0)/max1-&
&       temp6*max1d0)/max1
      dtm1d = temp6
      dtm1d0 = (cflm1d0-cflm1*max1d0/max1)/max1
      dtm1 = cflm1/max1
!write(30101,*) "i,j    =  ", i,j
!write(30101,*) "dtm1   =  ", dtm1
!write(30101,*) "distm1 =  ", distm1
!write(30101,*) "cflm1  =  ", dtm1
!write(30101,*) "mu     =  ", mu(i,j)
! compute diagonal coefficient------------------------------------------------------
! 1/dt ou 1.5/dt
      temp7 = dtm1*dtcoefd + dtcoef*dtm1d
      coefdiagdd(1:im, 1:jm, 1) = temp7*vold0(1:im, 1:jm) + vol(1:im, 1:&
&       jm)*(dtcoefd*dtm1d0+dtm1*dtcoefdd+dtm1d*dtcoefd0+dtcoef*dtm1dd) &
&       + vold(1:im, 1:jm)*(dtm1*dtcoefd0+dtcoef*dtm1d0) + dtcoef*dtm1*&
&       voldd(1:im, 1:jm)
      coefdiagd(1:im, 1:jm, 1) = vol(1:im, 1:jm)*temp7 + dtcoef*dtm1*&
&       vold(1:im, 1:jm)
      coefdiagd0(1:im, 1:jm, 1) = vol(1:im, 1:jm)*(dtm1*dtcoefd0+dtcoef*&
&       dtm1d0) + dtcoef*dtm1*vold0(1:im, 1:jm)
      coefdiag(1:im, 1:jm, 1) = dtcoef*dtm1*vol(1:im, 1:jm)
! 1/dt ou 1.5/dt
      temp7 = dtm1*dtcoefd + dtcoef*dtm1d
      coefdiagdd(1:im, 1:jm, 2) = temp7*vold0(1:im, 1:jm) + vol(1:im, 1:&
&       jm)*(dtcoefd*dtm1d0+dtm1*dtcoefdd+dtm1d*dtcoefd0+dtcoef*dtm1dd) &
&       + vold(1:im, 1:jm)*(dtm1*dtcoefd0+dtcoef*dtm1d0) + dtcoef*dtm1*&
&       voldd(1:im, 1:jm)
      coefdiagd(1:im, 1:jm, 2) = vol(1:im, 1:jm)*temp7 + dtcoef*dtm1*&
&       vold(1:im, 1:jm)
      coefdiagd0(1:im, 1:jm, 2) = vol(1:im, 1:jm)*(dtm1*dtcoefd0+dtcoef*&
&       dtm1d0) + dtcoef*dtm1*vold0(1:im, 1:jm)
      coefdiag(1:im, 1:jm, 2) = dtcoef*dtm1*vol(1:im, 1:jm)
    END DO
  END DO
  coefd = 0.0_8
  coefdd = 0.0_8
  coefd0 = 0.0_8
!
loop_kdir:DO kdir=1,2
    i0 = -kdir + 2
    j0 = kdir - 1
!
    DO j=1,jm+1
      DO i=1,im+1
        roldd = wdd(i-i0, j-j0, 1)
        rold = wd(i-i0, j-j0, 1)
        rold0 = wd0(i-i0, j-j0, 1)
        rol = w(i-i0, j-j0, 1)
        rordd = wdd(i, j, 1)
        rord = wd(i, j, 1)
        rord0 = wd0(i, j, 1)
        ror = w(i, j, 1)
        temp7 = rold/(rol*rol)
        rom1ldd = -(one*(roldd-temp7*2*rol*rold0)/rol**2)
        rom1ld = -(one*temp7)
        rom1ld0 = -(one*rold0/rol**2)
        rom1l = one/rol
        temp7 = rord/(ror*ror)
        rom1rdd = -(one*(rordd-temp7*2*ror*rord0)/ror**2)
        rom1rd = -(one*temp7)
        rom1rd0 = -(one*rord0/ror**2)
        rom1r = one/ror
        temp7 = 2.d0/(rol+ror)
        temp0d = -(temp7*(rold0+rord0)/(rol+ror))
        temp0 = temp7
        temp7 = temp0*(rold+rord)/(rol+ror)
        irodd = -(((rold+rord)*temp0d+temp0*(roldd+rordd)-temp7*(rold0+&
&         rord0))/(rol+ror))
        irod = -temp7
        irod0 = temp0d
        iro = temp0
        temp0d = wd0(i-i0, j-j0, 2)
        temp0 = w(i-i0, j-j0, 2)
        temp7 = wd(i-i0, j-j0, 2)
        uudd = half*(temp7*rom1ld0+rom1l*wdd(i-i0, j-j0, 2)+rom1ld*&
&         temp0d+temp0*rom1ldd+wd(i, j, 2)*rom1rd0+rom1r*wdd(i, j, 2)+&
&         rom1rd*wd0(i, j, 2)+w(i, j, 2)*rom1rdd)
        uud = half*(rom1l*temp7+temp0*rom1ld+rom1r*wd(i, j, 2)+w(i, j, 2&
&         )*rom1rd)
        uud0 = half*(rom1l*temp0d+temp0*rom1ld0+rom1r*wd0(i, j, 2)+w(i, &
&         j, 2)*rom1rd0)
        uu = half*(temp0*rom1l+w(i, j, 2)*rom1r)
        temp0d = wd0(i-i0, j-j0, 3)
        temp0 = w(i-i0, j-j0, 3)
        temp7 = wd(i-i0, j-j0, 3)
        vvdd = half*(temp7*rom1ld0+rom1l*wdd(i-i0, j-j0, 3)+rom1ld*&
&         temp0d+temp0*rom1ldd+wd(i, j, 3)*rom1rd0+rom1r*wdd(i, j, 3)+&
&         rom1rd*wd0(i, j, 3)+w(i, j, 3)*rom1rdd)
        vvd = half*(rom1l*temp7+temp0*rom1ld+rom1r*wd(i, j, 3)+w(i, j, 3&
&         )*rom1rd)
        vvd0 = half*(rom1l*temp0d+temp0*rom1ld0+rom1r*wd0(i, j, 3)+w(i, &
&         j, 3)*rom1rd0)
        vv = half*(temp0*rom1l+w(i, j, 3)*rom1r)
        temp0d = tlocd0(i-i0, j-j0) + tlocd0(i, j)
        temp0 = tloc(i-i0, j-j0) + tloc(i, j)
        temp7 = rgaz*gamd + gam*rgazd
        temp6 = tlocd(i-i0, j-j0) + tlocd(i, j)
        ccdd = half*(temp7*temp0d+temp0*(gamd*rgazd0+rgaz*gamdd+rgazd*&
&         gamd0+gam*rgazdd)+temp6*(rgaz*gamd0+gam*rgazd0)+gam*rgaz*(&
&         tlocdd(i-i0, j-j0)+tlocdd(i, j)))
        ccd = half*(temp0*temp7+gam*rgaz*temp6)
        ccd0 = half*(temp0*(rgaz*gamd0+gam*rgazd0)+gam*rgaz*temp0d)
        cc = half*(gam*rgaz*temp0)
        temp7 = 2*nx(i, j, kdir)
        temp6 = 2*ny(i, j, kdir)
        normdd = nxd(i, j, kdir)*2*nxd0(i, j, kdir) + temp7*nxdd(i, j, &
&         kdir) + nyd(i, j, kdir)*2*nyd0(i, j, kdir) + temp6*nydd(i, j, &
&         kdir)
        normd = temp7*nxd(i, j, kdir) + temp6*nyd(i, j, kdir)
        normd0 = 2*nx(i, j, kdir)*nxd0(i, j, kdir) + 2*ny(i, j, kdir)*&
&         nyd0(i, j, kdir)
        norm = nx(i, j, kdir)*nx(i, j, kdir) + ny(i, j, kdir)*ny(i, j, &
&         kdir)
        temp0d = mud0(i-i0, j-j0) + mud0(i, j)
        temp0 = mu(i-i0, j-j0) + mu(i, j)
        temp7 = mud(i-i0, j-j0) + mud(i, j)
        mutotdd = half*(gamprd*temp0d+temp0*gamprdd+temp7*gamprd0+gampr*&
&         (mudd(i-i0, j-j0)+mudd(i, j)))
        mutotd = half*(temp0*gamprd+gampr*temp7)
        mutotd0 = half*(temp0*gamprd0+gampr*temp0d)
        mutot = half*(gampr*temp0)
        temp0d = iro*(norm*mutotd0+mutot*normd0) + mutot*norm*irod0
        temp0 = mutot*norm*iro
        temp7 = norm*mutotd + mutot*normd
        temp6 = iro*temp7 + mutot*norm*irod
        specdiffdd = temp6*volfd0(i, j, kdir) + volf(i, j, kdir)*(temp7*&
&         irod0+iro*(mutotd*normd0+norm*mutotdd+normd*mutotd0+mutot*&
&         normdd)+irod*(norm*mutotd0+mutot*normd0)+mutot*norm*irodd) + &
&         volfd(i, j, kdir)*temp0d + temp0*volfdd(i, j, kdir)
        specdiffd = volf(i, j, kdir)*temp6 + temp0*volfd(i, j, kdir)
        specdiffd0 = volf(i, j, kdir)*temp0d + temp0*volfd0(i, j, kdir)
        specdiff = temp0*volf(i, j, kdir)
        x2dd = uud*nxd0(i, j, kdir) + nx(i, j, kdir)*uudd + nxd(i, j, &
&         kdir)*uud0 + uu*nxdd(i, j, kdir) + vvd*nyd0(i, j, kdir) + ny(i&
&         , j, kdir)*vvdd + nyd(i, j, kdir)*vvd0 + vv*nydd(i, j, kdir)
        x2d = nx(i, j, kdir)*uud + uu*nxd(i, j, kdir) + ny(i, j, kdir)*&
&         vvd + vv*nyd(i, j, kdir)
        x2d0 = nx(i, j, kdir)*uud0 + uu*nxd0(i, j, kdir) + ny(i, j, kdir&
&         )*vvd0 + vv*nyd0(i, j, kdir)
        x2 = uu*nx(i, j, kdir) + vv*ny(i, j, kdir)
        IF (x2 .GE. 0.) THEN
          abs0dd = x2dd
          abs0d = x2d
          abs0d0 = x2d0
          abs0 = x2
        ELSE
          abs0dd = -x2dd
          abs0d = -x2d
          abs0d0 = -x2d0
          abs0 = -x2
        END IF
        arg1dd = ccd*normd0 + norm*ccdd + normd*ccd0 + cc*normdd
        arg1d = norm*ccd + cc*normd
        arg1d0 = norm*ccd0 + cc*normd0
        arg1 = cc*norm
        temp7 = SQRT(arg1)
        IF (arg1 .EQ. 0.0) THEN
          temp0d = 0.0_8
        ELSE
          temp0d = arg1d0/(2.0*temp7)
        END IF
        temp0 = temp7
        IF (arg1 .EQ. 0.0) THEN
          result1d = 0.0_8
          result1dd = 0.0_8
        ELSE
          temp7 = arg1d/(2.0*temp0)
          result1dd = (arg1dd-temp7*2.0*temp0d)/(2.0*temp0)
          result1d = temp7
        END IF
        result1d0 = temp0d
        result1 = temp0
        coefdd(i, j, 1, kdir) = 0.5d0*(abs0dd+result1dd+two*specdiffdd)
        coefd(i, j, 1, kdir) = 0.5d0*(abs0d+result1d+two*specdiffd)
        coefd0(i, j, 1, kdir) = 0.5d0*(abs0d0+result1d0+two*specdiffd0)
        coef(i, j, 1, kdir) = 0.5d0*(abs0+result1+two*specdiff)
        mutotdd = half*(mudd(i-i0, j-j0)+mudd(i, j)+wdd(i-i0, j-j0, 6)+&
&         wdd(i, j, 6))
        mutotd = half*(mud(i-i0, j-j0)+mud(i, j)+wd(i-i0, j-j0, 6)+wd(i&
&         , j, 6))
        mutotd0 = half*(mud0(i-i0, j-j0)+mud0(i, j)+wd0(i-i0, j-j0, 6)+&
&         wd0(i, j, 6))
        mutot = half*(mu(i-i0, j-j0)+mu(i, j)+w(i-i0, j-j0, 6)+w(i, j, 6&
&         ))
! mutot = HALF * ( mu(i-i0,j-j0) + mu(i,j) + mut(i-i0,j-j0) + mut(i,j) )
        temp0d = norm*iro*(sigmainv*mutotd0+mutot*sigmainvd0) + mutot*&
&         sigmainv*(iro*normd0+norm*irod0)
        temp0 = mutot*sigmainv*norm*iro
        temp7 = iro*normd + norm*irod
        temp6 = sigmainv*mutotd + mutot*sigmainvd
        temp5 = norm*iro*temp6 + mutot*sigmainv*temp7
        diffturdd = volfd(i, j, kdir)*temp0d + temp0*volfdd(i, j, kdir) &
&         + temp5*volfd0(i, j, kdir) + volf(i, j, kdir)*(temp6*(iro*&
&         normd0+norm*irod0)+norm*iro*(mutotd*sigmainvd0+sigmainv*&
&         mutotdd+sigmainvd*mutotd0+mutot*sigmainvdd)+temp7*(sigmainv*&
&         mutotd0+mutot*sigmainvd0)+mutot*sigmainv*(normd*irod0+iro*&
&         normdd+irod*normd0+norm*irodd))
        diffturd = temp0*volfd(i, j, kdir) + volf(i, j, kdir)*temp5
        diffturd0 = temp0*volfd0(i, j, kdir) + volf(i, j, kdir)*temp0d
        difftur = volf(i, j, kdir)*temp0
        x3dd = uud*nxd0(i, j, kdir) + nx(i, j, kdir)*uudd + nxd(i, j, &
&         kdir)*uud0 + uu*nxdd(i, j, kdir) + vvd*nyd0(i, j, kdir) + ny(i&
&         , j, kdir)*vvdd + nyd(i, j, kdir)*vvd0 + vv*nydd(i, j, kdir)
        x3d = nx(i, j, kdir)*uud + uu*nxd(i, j, kdir) + ny(i, j, kdir)*&
&         vvd + vv*nyd(i, j, kdir)
        x3d0 = nx(i, j, kdir)*uud0 + uu*nxd0(i, j, kdir) + ny(i, j, kdir&
&         )*vvd0 + vv*nyd0(i, j, kdir)
        x3 = uu*nx(i, j, kdir) + vv*ny(i, j, kdir)
        IF (x3 .GE. 0.) THEN
          abs1dd = x3dd
          abs1d = x3d
          abs1d0 = x3d0
          abs1 = x3
        ELSE
          abs1dd = -x3dd
          abs1d = -x3d
          abs1d0 = -x3d0
          abs1 = -x3
        END IF
        arg1dd = ccd*normd0 + norm*ccdd + normd*ccd0 + cc*normdd
        arg1d = norm*ccd + cc*normd
        arg1d0 = norm*ccd0 + cc*normd0
        arg1 = cc*norm
        temp7 = SQRT(arg1)
        IF (arg1 .EQ. 0.0) THEN
          temp0d = 0.0_8
        ELSE
          temp0d = arg1d0/(2.0*temp7)
        END IF
        temp0 = temp7
        IF (arg1 .EQ. 0.0) THEN
          result1d = 0.0_8
          result1dd = 0.0_8
        ELSE
          temp7 = arg1d/(2.0*temp0)
          result1dd = (arg1dd-temp7*2.0*temp0d)/(2.0*temp0)
          result1d = temp7
        END IF
        result1d0 = temp0d
        result1 = temp0
        coefdd(i, j, 2, kdir) = 0.5d0*(abs1dd+result1dd+two*diffturdd)
        coefd(i, j, 2, kdir) = 0.5d0*(abs1d+result1d+two*diffturd)
        coefd0(i, j, 2, kdir) = 0.5d0*(abs1d0+result1d0+two*diffturd0)
        coef(i, j, 2, kdir) = 0.5d0*(abs1+result1+two*difftur)
      END DO
    END DO
    DO j=1,jm
      DO i=1,im
        coefdiagdd(i, j, 1) = coefdiagdd(i, j, 1) + coefdd(i, j, 1, kdir&
&         ) + coefdd(i+i0, j+j0, 1, kdir)
        coefdiagd(i, j, 1) = coefdiagd(i, j, 1) + coefd(i, j, 1, kdir) +&
&         coefd(i+i0, j+j0, 1, kdir)
        coefdiagd0(i, j, 1) = coefdiagd0(i, j, 1) + coefd0(i, j, 1, kdir&
&         ) + coefd0(i+i0, j+j0, 1, kdir)
        coefdiag(i, j, 1) = coefdiag(i, j, 1) + coef(i, j, 1, kdir) + &
&         coef(i+i0, j+j0, 1, kdir)
        coefdiagdd(i, j, 2) = coefdiagdd(i, j, 2) + coefdd(i, j, 2, kdir&
&         ) + coefdd(i+i0, j+j0, 2, kdir)
        coefdiagd(i, j, 2) = coefdiagd(i, j, 2) + coefd(i, j, 2, kdir) +&
&         coefd(i+i0, j+j0, 2, kdir)
        coefdiagd0(i, j, 2) = coefdiagd0(i, j, 2) + coefd0(i, j, 2, kdir&
&         ) + coefd0(i+i0, j+j0, 2, kdir)
        coefdiag(i, j, 2) = coefdiag(i, j, 2) + coef(i, j, 2, kdir) + &
&         coef(i+i0, j+j0, 2, kdir)
      END DO
    END DO
  END DO loop_kdir
  dwid = 0.0_8
  hnd = 0.0_8
  fid = 0.0_8
  dfid = 0.0_8
  d2wd = 0.0_8
  gid = 0.0_8
  dgid = 0.0_8
  dwidd = 0.0_8
  dwid0 = 0.0_8
  hnd0 = 0.0_8
  gidd = 0.0_8
  dgidd = 0.0_8
  d2wdd = 0.0_8
  hndd = 0.0_8
  fid0 = 0.0_8
  dfid0 = 0.0_8
  d2wd0 = 0.0_8
  fidd = 0.0_8
  dfidd = 0.0_8
  gid0 = 0.0_8
  dgid0 = 0.0_8
!
loop_subite:DO l=1,lmax
!
    DO equa=1,em
      d2wdd(0:im+1, 0:jm+1, equa) = dwd(0:im+1, 0:jm+1, equa)*vold0(0:im&
&       +1, 0:jm+1) + vol(0:im+1, 0:jm+1)*dwdd(0:im+1, 0:jm+1, equa) + &
&       vold(0:im+1, 0:jm+1)*dwd0(0:im+1, 0:jm+1, equa) + dw(0:im+1, 0:&
&       jm+1, equa)*voldd(0:im+1, 0:jm+1)
      d2wd(0:im+1, 0:jm+1, equa) = vol(0:im+1, 0:jm+1)*dwd(0:im+1, 0:jm+&
&       1, equa) + dw(0:im+1, 0:jm+1, equa)*vold(0:im+1, 0:jm+1)
      d2wd0(0:im+1, 0:jm+1, equa) = vol(0:im+1, 0:jm+1)*dwd0(0:im+1, 0:&
&       jm+1, equa) + dw(0:im+1, 0:jm+1, equa)*vold0(0:im+1, 0:jm+1)
      d2w(0:im+1, 0:jm+1, equa) = dw(0:im+1, 0:jm+1, equa)*vol(0:im+1, 0&
&       :jm+1)
    END DO
!
! Computation of the left hand side
!
loop_kdir_inner:DO kdir=1,2
      i0 = -kdir + 2
      j0 = kdir - 1
!
      DO j=1,jm+j0
        DO i=1,im+i0
!norm = dsqrt( nx(i,j,kdir)**2 + ny(i,j,kdir)**2)
          temp1d = dfid0(i-i0, j-j0, :) + dfid0(i, j, :)
          temp1 = dfi(i-i0, j-j0, :) + dfi(i, j, :)
          temp2d = dgid0(i-i0, j-j0, :) + dgid0(i, j, :)
          temp2 = dgi(i-i0, j-j0, :) + dgi(i, j, :)
          temp8 = dfid(i-i0, j-j0, :) + dfid(i, j, :)
          temp9 = dgid(i-i0, j-j0, :) + dgid(i, j, :)
          hndd(i, j, :) = half*(temp8*nxd0(i, j, kdir)+nx(i, j, kdir)*(&
&           dfidd(i-i0, j-j0, :)+dfidd(i, j, :))+nxd(i, j, kdir)*temp1d+&
&           temp1*nxdd(i, j, kdir)) + half*(temp9*nyd0(i, j, kdir)+ny(i&
&           , j, kdir)*(dgidd(i-i0, j-j0, :)+dgidd(i, j, :))+nyd(i, j, &
&           kdir)*temp2d+temp2*nydd(i, j, kdir))
          hnd(i, j, :) = half*(nx(i, j, kdir)*temp8+temp1*nxd(i, j, kdir&
&           )) + half*(ny(i, j, kdir)*temp9+temp2*nyd(i, j, kdir))
          hnd0(i, j, :) = half*(nx(i, j, kdir)*temp1d+temp1*nxd0(i, j, &
&           kdir)) + half*(ny(i, j, kdir)*temp2d+temp2*nyd0(i, j, kdir))
          hn(i, j, :) = half*(temp1*nx(i, j, kdir)) + half*(temp2*ny(i, &
&           j, kdir))
        END DO
      END DO
!
      DO j=1,jm
        DO i=1,im
          temp0d = coefd0(i+i0, j+j0, 1, kdir)
          temp0 = coef(i+i0, j+j0, 1, kdir)
          temp7 = coefd(i+i0, j+j0, 1, kdir)
          d2wdd(i, j, 1:5) = d2wdd(i, j, 1:5) + hndd(i, j, 1:5) + coefd(&
&           i, j, 1, kdir)*dwid0(i-i0, j-j0, 1:5) + dwi(i-i0, j-j0, 1:5)&
&           *coefdd(i, j, 1, kdir) - hndd(i+i0, j+j0, 1:5) + dwid(i-i0, &
&           j-j0, 1:5)*coefd0(i, j, 1, kdir) + coef(i, j, 1, kdir)*dwidd&
&           (i-i0, j-j0, 1:5) + temp7*dwid0(i+i0, j+j0, 1:5) + dwi(i+i0&
&           , j+j0, 1:5)*coefdd(i+i0, j+j0, 1, kdir) + dwid(i+i0, j+j0, &
&           1:5)*temp0d + temp0*dwidd(i+i0, j+j0, 1:5)
          d2wd(i, j, 1:5) = d2wd(i, j, 1:5) + hnd(i, j, 1:5) + dwi(i-i0&
&           , j-j0, 1:5)*coefd(i, j, 1, kdir) - hnd(i+i0, j+j0, 1:5) + &
&           coef(i, j, 1, kdir)*dwid(i-i0, j-j0, 1:5) + dwi(i+i0, j+j0, &
&           1:5)*temp7 + temp0*dwid(i+i0, j+j0, 1:5)
          d2wd0(i, j, 1:5) = d2wd0(i, j, 1:5) + hnd0(i, j, 1:5) - hnd0(i&
&           +i0, j+j0, 1:5) + dwi(i-i0, j-j0, 1:5)*coefd0(i, j, 1, kdir)&
&           + coef(i, j, 1, kdir)*dwid0(i-i0, j-j0, 1:5) + dwi(i+i0, j+&
&           j0, 1:5)*temp0d + temp0*dwid0(i+i0, j+j0, 1:5)
          d2w(i, j, 1:5) = d2w(i, j, 1:5) + hn(i, j, 1:5) - hn(i+i0, j+&
&           j0, 1:5) + coef(i, j, 1, kdir)*dwi(i-i0, j-j0, 1:5) + temp0*&
&           dwi(i+i0, j+j0, 1:5)
        END DO
      END DO
      DO equa=6,em
        DO j=1,jm
          DO i=1,im
            temp0d = dwid0(i-i0, j-j0, equa)
            temp0 = dwi(i-i0, j-j0, equa)
            tempd = dwid0(i+i0, j+j0, equa)
            temp = dwi(i+i0, j+j0, equa)
            temp3d = coefd0(i+i0, j+j0, 2, kdir)
            temp3 = coef(i+i0, j+j0, 2, kdir)
            temp7 = dwid(i-i0, j-j0, equa)
            temp6 = coefd(i+i0, j+j0, 2, kdir)
            temp5 = dwid(i+i0, j+j0, equa)
            d2wdd(i, j, equa) = d2wdd(i, j, equa) + hndd(i, j, equa) + &
&             coefd(i, j, 2, kdir)*temp0d + temp0*coefdd(i, j, 2, kdir) &
&             - hndd(i+i0, j+j0, equa) + temp7*coefd0(i, j, 2, kdir) + &
&             coef(i, j, 2, kdir)*dwidd(i-i0, j-j0, equa) + temp6*tempd &
&             + temp*coefdd(i+i0, j+j0, 2, kdir) + temp5*temp3d + temp3*&
&             dwidd(i+i0, j+j0, equa)
            d2wd(i, j, equa) = d2wd(i, j, equa) + hnd(i, j, equa) + &
&             temp0*coefd(i, j, 2, kdir) - hnd(i+i0, j+j0, equa) + coef(&
&             i, j, 2, kdir)*temp7 + temp*temp6 + temp3*temp5
            d2wd0(i, j, equa) = d2wd0(i, j, equa) + hnd0(i, j, equa) - &
&             hnd0(i+i0, j+j0, equa) + temp0*coefd0(i, j, 2, kdir) + &
&             coef(i, j, 2, kdir)*temp0d + temp*temp3d + temp3*tempd
            d2w(i, j, equa) = d2w(i, j, equa) + hn(i, j, equa) - hn(i+i0&
&             , j+j0, equa) + coef(i, j, 2, kdir)*temp0 + temp3*temp
          END DO
        END DO
      END DO
    END DO loop_kdir_inner
!
! Computation of the intermediate increment
!
    temp10 = d2w(1:im, 1:jm, 1)/coefdiag(1:im, 1:jm, 1)
    temp4d = (d2wd0(1:im, 1:jm, 1)-temp10*coefdiagd0(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    temp4 = temp10
    temp10 = (d2wd(1:im, 1:jm, 1)-temp4*coefdiagd(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    dwidd(1:im, 1:jm, 1) = (d2wdd(1:im, 1:jm, 1)-coefdiagd(1:im, 1:jm, 1&
&     )*temp4d-temp4*coefdiagdd(1:im, 1:jm, 1)-temp10*coefdiagd0(1:im, 1&
&     :jm, 1))/coefdiag(1:im, 1:jm, 1)
    dwid(1:im, 1:jm, 1) = temp10
    dwid0(1:im, 1:jm, 1) = temp4d
    dwi(1:im, 1:jm, 1) = temp4
    temp10 = d2w(1:im, 1:jm, 2)/coefdiag(1:im, 1:jm, 1)
    temp4d = (d2wd0(1:im, 1:jm, 2)-temp10*coefdiagd0(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    temp4 = temp10
    temp10 = (d2wd(1:im, 1:jm, 2)-temp4*coefdiagd(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    dwidd(1:im, 1:jm, 2) = (d2wdd(1:im, 1:jm, 2)-coefdiagd(1:im, 1:jm, 1&
&     )*temp4d-temp4*coefdiagdd(1:im, 1:jm, 1)-temp10*coefdiagd0(1:im, 1&
&     :jm, 1))/coefdiag(1:im, 1:jm, 1)
    dwid(1:im, 1:jm, 2) = temp10
    dwid0(1:im, 1:jm, 2) = temp4d
    dwi(1:im, 1:jm, 2) = temp4
    temp10 = d2w(1:im, 1:jm, 3)/coefdiag(1:im, 1:jm, 1)
    temp4d = (d2wd0(1:im, 1:jm, 3)-temp10*coefdiagd0(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    temp4 = temp10
    temp10 = (d2wd(1:im, 1:jm, 3)-temp4*coefdiagd(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    dwidd(1:im, 1:jm, 3) = (d2wdd(1:im, 1:jm, 3)-coefdiagd(1:im, 1:jm, 1&
&     )*temp4d-temp4*coefdiagdd(1:im, 1:jm, 1)-temp10*coefdiagd0(1:im, 1&
&     :jm, 1))/coefdiag(1:im, 1:jm, 1)
    dwid(1:im, 1:jm, 3) = temp10
    dwid0(1:im, 1:jm, 3) = temp4d
    dwi(1:im, 1:jm, 3) = temp4
    temp10 = d2w(1:im, 1:jm, 4)/coefdiag(1:im, 1:jm, 1)
    temp4d = (d2wd0(1:im, 1:jm, 4)-temp10*coefdiagd0(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    temp4 = temp10
    temp10 = (d2wd(1:im, 1:jm, 4)-temp4*coefdiagd(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    dwidd(1:im, 1:jm, 4) = (d2wdd(1:im, 1:jm, 4)-coefdiagd(1:im, 1:jm, 1&
&     )*temp4d-temp4*coefdiagdd(1:im, 1:jm, 1)-temp10*coefdiagd0(1:im, 1&
&     :jm, 1))/coefdiag(1:im, 1:jm, 1)
    dwid(1:im, 1:jm, 4) = temp10
    dwid0(1:im, 1:jm, 4) = temp4d
    dwi(1:im, 1:jm, 4) = temp4
    temp10 = d2w(1:im, 1:jm, 5)/coefdiag(1:im, 1:jm, 1)
    temp4d = (d2wd0(1:im, 1:jm, 5)-temp10*coefdiagd0(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    temp4 = temp10
    temp10 = (d2wd(1:im, 1:jm, 5)-temp4*coefdiagd(1:im, 1:jm, 1))/&
&     coefdiag(1:im, 1:jm, 1)
    dwidd(1:im, 1:jm, 5) = (d2wdd(1:im, 1:jm, 5)-coefdiagd(1:im, 1:jm, 1&
&     )*temp4d-temp4*coefdiagdd(1:im, 1:jm, 1)-temp10*coefdiagd0(1:im, 1&
&     :jm, 1))/coefdiag(1:im, 1:jm, 1)
    dwid(1:im, 1:jm, 5) = temp10
    dwid0(1:im, 1:jm, 5) = temp4d
    dwi(1:im, 1:jm, 5) = temp4
    DO equa=6,em
      temp10 = d2w(1:im, 1:jm, equa)/(coefdiag(1:im, 1:jm, 2)+src_i(1:im&
&       , 1:jm))
      temp4d = (d2wd0(1:im, 1:jm, equa)-temp10*(coefdiagd0(1:im, 1:jm, 2&
&       )+src_id0(1:im, 1:jm)))/(coefdiag(1:im, 1:jm, 2)+src_i(1:im, 1:&
&       jm))
      temp4 = temp10
      temp10 = (d2wd(1:im, 1:jm, equa)-temp4*(coefdiagd(1:im, 1:jm, 2)+&
&       src_id(1:im, 1:jm)))/(coefdiag(1:im, 1:jm, 2)+src_i(1:im, 1:jm))
      dwidd(1:im, 1:jm, equa) = (d2wdd(1:im, 1:jm, equa)-(coefdiagd(1:im&
&       , 1:jm, 2)+src_id(1:im, 1:jm))*temp4d-temp4*(coefdiagdd(1:im, 1:&
&       jm, 2)+src_idd(1:im, 1:jm))-temp10*(coefdiagd0(1:im, 1:jm, 2)+&
&       src_id0(1:im, 1:jm)))/(coefdiag(1:im, 1:jm, 2)+src_i(1:im, 1:jm)&
&       )
      dwid(1:im, 1:jm, equa) = temp10
      dwid0(1:im, 1:jm, equa) = temp4d
      dwi(1:im, 1:jm, equa) = temp4
    END DO
!
! Actualisation de wi
!
    DO j=1,jm
      DO i=1,im
        widd(:) = wdd(i, j, :) + dwidd(i, j, :)
        wid(:) = wd(i, j, :) + dwid(i, j, :)
        wid0(:) = wd0(i, j, :) + dwid0(i, j, :)
        wi(:) = w(i, j, :) + dwi(i, j, :)
        temp7 = one/wi(1)
        temp3d = -(temp7*wid0(1)/wi(1))
        temp3 = temp7
        temp7 = temp3*wid(1)/wi(1)
        rhom1dd = -((wid(1)*temp3d+temp3*widd(1)-temp7*wid0(1))/wi(1))
        rhom1d = -temp7
        rhom1d0 = temp3d
        rhom1 = temp3
        velxidd = wid(2)*rhom1d0 + rhom1*widd(2) + rhom1d*wid0(2) + wi(2&
&         )*rhom1dd
        velxid = rhom1*wid(2) + wi(2)*rhom1d
        velxid0 = rhom1*wid0(2) + wi(2)*rhom1d0
        velxi = wi(2)*rhom1
        velyidd = wid(3)*rhom1d0 + rhom1*widd(3) + rhom1d*wid0(3) + wi(3&
&         )*rhom1dd
        velyid = rhom1*wid(3) + wi(3)*rhom1d
        velyid0 = rhom1*wid0(3) + wi(3)*rhom1d0
        velyi = wi(3)*rhom1
        velzidd = wid(4)*rhom1d0 + rhom1*widd(4) + rhom1d*wid0(4) + wi(4&
&         )*rhom1dd
        velzid = rhom1*wid(4) + wi(4)*rhom1d
        velzid0 = rhom1*wid0(4) + wi(4)*rhom1d0
        velzi = wi(4)*rhom1
        temp3d = 2*velxi*velxid0 + 2*velyi*velyid0 + 2*velzi*velzid0
        temp3 = velxi*velxi + velyi*velyi + velzi*velzi
        temp0d = wid0(5) - half*(temp3*wid0(1)+wi(1)*temp3d)
        temp0 = wi(5) - half*wi(1)*temp3
        temp7 = 2*velxi*velxid + 2*velyi*velyid + 2*velzi*velzid
        temp6 = wid(5) - half*(temp3*wid(1)+wi(1)*temp7)
        pintdd = gam1d*temp0d + temp0*gam1dd + temp6*gam1d0 + gam1*(widd&
&         (5)-half*(wid(1)*temp3d+temp3*widd(1)+temp7*wid0(1)+wi(1)*(&
&         velxid*2*velxid0+2*velxi*velxidd+velyid*2*velyid0+2*velyi*&
&         velyidd+velzid*2*velzid0+2*velzi*velzidd)))
        pintd = temp0*gam1d + gam1*temp6
        pintd0 = temp0*gam1d0 + gam1*temp0d
        pint = gam1*temp0
!
! Actualisation des flux intermediaires
        fidd(1) = widd(2)
        fid(1) = wid(2)
        fid0(1) = wid0(2)
        fi(1) = wi(2)
        fidd(2) = wid(2)*velxid0 + velxi*widd(2) + velxid*wid0(2) + wi(2&
&         )*velxidd + pintdd
        fid(2) = velxi*wid(2) + wi(2)*velxid + pintd
        fid0(2) = velxi*wid0(2) + wi(2)*velxid0 + pintd0
        fi(2) = wi(2)*velxi + pint
        fidd(3) = wid(2)*velyid0 + velyi*widd(2) + velyid*wid0(2) + wi(2&
&         )*velyidd
        fid(3) = velyi*wid(2) + wi(2)*velyid
        fid0(3) = velyi*wid0(2) + wi(2)*velyid0
        fi(3) = wi(2)*velyi
        fidd(4) = wid(2)*velzid0 + velzi*widd(2) + velzid*wid0(2) + wi(2&
&         )*velzidd
        fid(4) = velzi*wid(2) + wi(2)*velzid
        fid0(4) = velzi*wid0(2) + wi(2)*velzid0
        fi(4) = wi(2)*velzi
        fidd(5) = velxid*(wid0(5)+pintd0) + (wi(5)+pint)*velxidd + (wid(&
&         5)+pintd)*velxid0 + velxi*(widd(5)+pintdd)
        fid(5) = (wi(5)+pint)*velxid + velxi*(wid(5)+pintd)
        fid0(5) = (wi(5)+pint)*velxid0 + velxi*(wid0(5)+pintd0)
        fi(5) = velxi*(wi(5)+pint)
        gidd(1) = widd(3)
        gid(1) = wid(3)
        gid0(1) = wid0(3)
        gi(1) = wi(3)
        gidd(2) = wid(3)*velxid0 + velxi*widd(3) + velxid*wid0(3) + wi(3&
&         )*velxidd
        gid(2) = velxi*wid(3) + wi(3)*velxid
        gid0(2) = velxi*wid0(3) + wi(3)*velxid0
        gi(2) = wi(3)*velxi
        gidd(3) = wid(3)*velyid0 + velyi*widd(3) + velyid*wid0(3) + wi(3&
&         )*velyidd + pintdd
        gid(3) = velyi*wid(3) + wi(3)*velyid + pintd
        gid0(3) = velyi*wid0(3) + wi(3)*velyid0 + pintd0
        gi(3) = wi(3)*velyi + pint
        gidd(4) = wid(3)*velzid0 + velzi*widd(3) + velzid*wid0(3) + wi(3&
&         )*velzidd
        gid(4) = velzi*wid(3) + wi(3)*velzid
        gid0(4) = velzi*wid0(3) + wi(3)*velzid0
        gi(4) = wi(3)*velzi
        gidd(5) = velyid*(wid0(5)+pintd0) + (wi(5)+pint)*velyidd + (wid(&
&         5)+pintd)*velyid0 + velyi*(widd(5)+pintdd)
        gid(5) = (wi(5)+pint)*velyid + velyi*(wid(5)+pintd)
        gid0(5) = (wi(5)+pint)*velyid0 + velyi*(wid0(5)+pintd0)
        gi(5) = velyi*(wi(5)+pint)
! turbulent quantities
        fidd(6:em) = velxid*wid0(6:em) + wi(6:em)*velxidd + wid(6:em)*&
&         velxid0 + velxi*widd(6:em)
        fid(6:em) = wi(6:em)*velxid + velxi*wid(6:em)
        fid0(6:em) = wi(6:em)*velxid0 + velxi*wid0(6:em)
        fi(6:em) = velxi*wi(6:em)
        gidd(6:em) = velyid*wid0(6:em) + wi(6:em)*velyidd + wid(6:em)*&
&         velyid0 + velyi*widd(6:em)
        gid(6:em) = wi(6:em)*velyid + velyi*wid(6:em)
        gid0(6:em) = wi(6:em)*velyid0 + velyi*wid0(6:em)
        gi(6:em) = velyi*wi(6:em)
! Calcul des increments des flux
        dfidd(i, j, :) = fidd(:) - fdd(i, j, :)
        dfid(i, j, :) = fid(:) - fd(i, j, :)
        dfid0(i, j, :) = fid0(:) - fd0(i, j, :)
        dfi(i, j, :) = fi(:) - f(i, j, :)
        dgidd(i, j, :) = gidd(:) - gdd(i, j, :)
        dgid(i, j, :) = gid(:) - gd(i, j, :)
        dgid0(i, j, :) = gid0(:) - gd0(i, j, :)
        dgi(i, j, :) = gi(:) - g(i, j, :)
      END DO
    END DO
  END DO loop_subite
END SUBROUTINE IMPLI_MATRIX_FREE_RANS_2D_D_D
!

